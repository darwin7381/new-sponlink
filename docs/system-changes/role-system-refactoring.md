# 角色系統重構記錄

## 背景

BlockMeet 平台最初採用了固定角色模型（USER_ROLES），將用戶嚴格區分為「贊助商」和「組織者」。這種設計導致了以下問題：

1. **雙重身份衝突**：用戶無法同時擔任贊助商和組織者角色
2. **功能訪問限制**：基於角色的頁面權限阻止用戶使用所有功能
3. **界面分散**：相似功能在不同角色下分散在不同頁面
4. **擴展性問題**：難以支持更複雜的企業/團隊結構
5. **角色固化**：用戶無法同時扮演多種角色，例如一個贊助商不能以個人身份創建活動，反之亦然。

## 變更內容

2025-04-11，我們完成了角色系統重構，具體變更如下：

1. **移除 USER_ROLES 依賴**：
   - 移除了數據庫中的 `role` 欄位
   - 將所有基於舊 role 的權限檢查替換為通用登入檢查

2. **引入系統角色**：
   - 新增了 `SystemRole` 枚舉，區分普通用戶 (USER) 和系統管理員 (ADMIN)
   - 在用戶表中添加了 `system_role` 欄位，默認為 'USER'
   - 所有已登入用戶可訪問所有功能，僅系統管理功能需要 ADMIN 角色

3. **為未來擴展做準備**：
   - 資源模型增加 `owner_id` 和 `owner_type` 欄位，支持多種所有權類型
   - 保留 `activity_id` 欄位，為多租戶功能做準備

## 實施步驟與教訓

實施過程遇到的問題與解決方案：

1. **不應使用過渡/兼容方案**：
   - 初始實施嘗試保留舊欄位並添加註釋，這是錯誤的
   - 正確方案：徹底刪除舊欄位，完全採用新模型
   - 教訓：重構時，果斷移除棄用字段更為乾淨

2. **數據庫變更先於代碼變更**：
   - 先修改數據庫架構，再更新引用該字段的代碼
   - 確保使用相同的術語（如 `systemRole` 而非多種變體）

3. **保持文檔同步**：
   - 更新 identity_system_integration_proposal.md 反映最新變更
   - 添加警告文件提醒開發者不使用已棄用字段

## 開發者注意事項

1. **不再使用 USER_ROLES**：
   - 所有代碼應使用 `SystemRole` 枚舉
   - 權限檢查應使用 `isAuthenticated()` 或 `isSystemAdmin()`
   - ESLint 會警告使用已棄用的 `user.role` 屬性

2. **新增資源時注意所有權**：
   - 所有資源必須設置 `owner_id` 和 `owner_type`
   - 權限檢查應基於資源所有權，而非用戶角色

3. **避免重新引入角色限制**：
   - 不要創建限制特定用戶組訪問的頁面
   - 使用視角切換而非角色限制來定制用戶體驗

## 未來發展

1. **階段二：實現組織結構**
   - 添加組織模型和成員關係
   - 實現組織內角色（Owner, Admin, Member, Guest）

2. **階段三：添加團隊支持**
   - 添加團隊模型作為組織的子單位
   - 實現團隊內角色和權限

3. **最終目標**：
   - 完全基於資源所有權和顯式權限的授權模型
   - 支持組織和團隊級別的多用戶協作

## 技術參考

相關文件和代碼變更：
- `src/lib/types/users.ts` - 定義 SystemRole 枚舉
- `src/db/schema/users.ts` - 更新數據庫模式
- `src/lib/services/authService.ts` - 添加 isSystemAdmin() 函數
- `docs/identity_system_integration_proposal.md` - 身份系統整合方案 