# 資料庫設計經驗教訓

## 背景

在BlockMeet專案的早期開發階段，我們採用了一些不標準的資料庫設計模式，包括：

1. 在用戶資料表中使用JSON欄位（profile_data）存儲複雜的結構化資料
2. 用戶ID採用特殊格式而非標準UUID
3. 缺乏適當的資料正規化

這些決策導致了多種問題，從而促使我們進行了重構。本文檔記錄我們的經驗和教訓。

## 主要問題

### 1. JSON資料存儲

**問題**：我們使用`profile_data` JSON欄位存儲用戶頭像、統計數據等結構化資訊，導致：
- 查詢複雜（需要JSON解析）
- 無法建立欄位索引
- 數據一致性難以保證
- 數據驗證困難
- 佔用額外空間
- 數據變更困難

**解決方案**：將JSON中的數據遷移到專用欄位和表中：
- 頭像URL → avatar_url欄位
- 統計數據 → user_statistics表

### 2. 特殊ID格式

**問題**：我們在系統中混用了不同格式的用戶ID，包括：
- 具有特殊前綴的ID ("user_XXX")
- 標準UUID

導致系統需要額外的ID轉換邏輯，增加了複雜性和出錯機會。

**解決方案**：
- 統一採用標準UUID格式
- 移除所有ID格式轉換代碼
- 資料庫中確保ID欄位保持一致

### 3. 缺乏資料正規化

**問題**：將不同類型的資料混合在少數幾個表中，導致：
- 表結構臃腫
- 查詢效率低下
- 難以維護和擴展

**解決方案**：將用戶相關資料拆分為多個專用表：
- users：核心用戶資訊
- user_profiles：用戶個人資料
- user_settings：用戶偏好設置
- user_statistics：統計數據

## 經驗教訓

1. **避免在關係型資料庫中使用JSON存儲結構化資料**
   - JSON適用於存儲偶爾需要的半結構化數據
   - 經常查詢或需要索引的數據應使用專用欄位

2. **始終使用標準化的ID格式**
   - 避免自定義ID格式和轉換邏輯
   - UUID提供了全球唯一性和良好的分散性

3. **遵循資料庫正規化原則**
   - 每個表應有明確單一的責任
   - 避免數據冗餘和異常
   - 合理使用外鍵關係

4. **保持代碼和資料庫設計一致**
   - 數據庫架構變更應同步更新相關代碼
   - 不要在應用層實現應該在數據庫層處理的邏輯

## 執行遷移步驟

我們執行了以下步驟進行遷移：

1. 創建新的資料表結構
2. 添加新欄位（如avatar_url）
3. 從JSON中提取數據並遷移到適當的表和欄位
4. 更新應用程式代碼以使用新的資料結構
5. 移除舊的JSON欄位和特殊ID處理邏輯
6. 測試所有功能以確保正常運作

## 結論

這次重構顯著提高了系統的穩定性、可維護性和擴展性。雖然過程耗時，但帶來的長期好處遠超短期成本。特別是：

- 系統更加可靠，不再有ID轉換的問題
- 數據結構更清晰，便於新團隊成員理解
- 查詢效率提升，特別是針對特定數據類型的查詢
- 數據完整性和一致性得到更好保障

未來的專案應從一開始就採用這些最佳實踐，避免後期的大規模重構。 