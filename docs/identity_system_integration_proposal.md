# SponLink 身份系統整合方案

## 一、當前身份系統現狀分析

### 1.1 現有身份類型

系統目前支持三種主要用戶角色：
- **贊助商 (Sponsor)**：可以瀏覽活動、購買贊助方案、安排與組織者的會議
- **組織者 (Organizer)**：可以創建和管理活動、設置贊助方案、與贊助商會面
- **管理員 (Admin)**：系統管理人員，擁有全部權限

### 1.2 各身份特有功能

#### 贊助商 (Sponsor) 功能：
- 儀表盤統計（總贊助數、總投資金額、會議數）
- 我的贊助管理
- 購物車功能
- 會議預約和管理

#### 組織者 (Organizer) 功能：
- 儀表盤統計（總活動數、即將到來的會議、贊助商數量）
- 活動創建與管理
- 會議確認與管理

#### 管理員 (Admin) 功能：
- 用戶管理
- 活動審核
- 系統配置
- 數據分析與報表

### 1.3 現有問題

1. **雙重身份衝突**：公司可能同時是贊助商又是組織者，但系統目前以單一身份模式運作
2. **界面分散**：相似功能（如會議管理）在不同身份下分散在不同頁面
3. **上下文切換困難**：無法在保持同一會話的情況下切換身份視角
4. **缺乏統一視圖**：需要登出並使用不同賬號查看不同身份的數據和功能
5. **無企業多用戶支持**：目前身份系統基於個人用戶設計，缺乏對企業多用戶協作的支持

## 二、整合方案建議

### 2.1 核心設計理念

身份系統不應該將用戶限制在特定角色中，而應該提供基於以下原則的通用體驗：

1. **所有用戶都可以執行基本操作**：創建活動、贊助活動等基本功能對所有登入用戶開放
2. **進階權限基於資源所有權**：用戶只能管理自己擁有的資源（如自己創建的活動、自己的贊助）
3. **視角而非角色**：用戶可以選擇不同視角來關注不同類型的任務，而非被限制在固定角色中
4. **組織情境支持**：用戶可以在個人與組織身份間切換，操作組織資源

### 2.2 簡化用戶與資源模型

```typescript
// 簡化用戶模型
interface User {
  id: string;
  email: string;
  name: string;
  isAdmin?: boolean;            // 只有管理員需要特殊標記
  organizations?: string[];     // 用戶所屬組織ID列表
  activeOrganizationId?: string; // 當前選擇的組織ID（操作上下文）
}

// 資源基礎模型（活動、贊助等）
interface Resource {
  id: string;
  ownerId: string;         // 資源擁有者ID（用戶或組織）
  ownerType: 'user' | 'organization'; // 擁有者類型
  createdAt: Date;
  // 其他共享屬性...
}
```

### 2.3 基於所有權的權限管理

權限不再基於用戶角色，而是基於資源所有權：

- 用戶可以管理自己創建的資源
- 組織成員可以根據組織內權限管理組織資源
- 管理員可以管理所有資源

```typescript
// 權限檢查基於資源所有權
function canManageResource(userId: string, resource: Resource): boolean {
  // 管理員可以管理所有資源
  if (currentUser.isAdmin) return true;
  
  // 用戶可以管理自己的資源
  if (resource.ownerType === 'user' && resource.ownerId === userId) {
    return true;
  }
  
  // 如果是組織資源，檢查用戶的組織權限
  if (resource.ownerType === 'organization') {
    return hasOrganizationPermission(userId, resource.ownerId, 'manage_resources');
  }
  
  return false;
}
```

## 三、視角模型與情境化功能

### 3.1 視角模型

用戶不受限於固定角色，而是可以自由選擇查看系統的視角：

1. **活動組織視角**：聚焦於用戶創建的活動、管理贊助方案、查看活動數據
2. **贊助管理視角**：聚焦於用戶贊助的活動、管理贊助訂單、查看投資回報
3. **系統管理視角**：僅限管理員，聚焦於全平台管理功能

### 3.2 視角切換機制

```
+--------------------------------------------------+
|  SponLink    [活動組織 ▾]    [個人 ▾]    [用戶 ▾] |
|              ┌─────────────┐                     |
|              │ 活動組織     │                     |
|              │ 贊助管理     │                     |
|              └─────────────┘                     |
+--------------------------------------------------+
```

視角切換不改變用戶權限，只改變信息展示重點和操作焦點。

### 3.3 情境化內容

根據用戶當前視角和情境，系統自動調整顯示內容：

- **儀表盤**：根據當前視角顯示相關數據（活動數據或贊助數據）
- **資源列表**：根據當前視角顯示相關資源（我的活動或我的贊助）
- **操作選項**：根據資源所有權顯示管理選項

## 四、使用情境詳細設計

### 4.1 未登入使用

**可用功能**：
- 活動瀏覽與搜索
- 活動篩選與排序
- 基本活動詳情查看
- 活動比較（本地暫存）
- 公開信息查詢

**設計原則**：
- 無障礙探索體驗
- 引導但不強制登入
- 功能入口保持可見，點擊受限功能時提示登入

### 4.2 登入後使用

**增加的功能**：
- 個人收藏與偏好設置
- 創建和管理活動
- 贊助活動
- 預約和管理會議
- 個人資料管理

**設計原則**：
- 所有基本功能對所有登入用戶開放
- 管理功能僅對資源擁有者開放
- 提供視角切換，優化特定任務工作流

### 4.3 組織情境使用

**組織功能**：
- 以組織名義創建活動
- 以組織名義贊助活動
- 組織成員協作管理資源
- 組織級數據分析

**設計原則**：
- 組織資源與個人資源清晰分離
- 組織內權限控制成員操作範圍
- 組織情境切換不改變用戶界面結構

## 五、企業/團隊多用戶支持

### 5.1 簡化組織模型

```typescript
// 組織模型
interface Organization {
  id: string;
  name: string;
  logo?: string;
  members: OrganizationMember[];
}

// 組織成員
interface OrganizationMember {
  userId: string;
  role: 'admin' | 'member' | 'viewer';  // 簡化的角色設計
}

// 組織角色權限
const OrganizationRolePermissions = {
  'admin': ['manage_organization', 'manage_members', 'manage_resources', 'view_analytics'],
  'member': ['create_resources', 'manage_own_resources', 'view_resources'],
  'viewer': ['view_resources']
};
```

### 5.2 組織管理與協作

- **組織創建**：任何用戶都可以創建組織，自動成為管理員
- **成員邀請**：管理員可以邀請其他用戶加入組織
- **資源協作**：成員可以根據權限共同管理組織資源
- **組織情境**：用戶可以在個人與組織情境間切換

### 5.3 組織與個人情境切換

組織情境切換改變用戶操作的主體（從個人變為組織），但不改變視角或界面結構：

```
1. 用戶以個人身份瀏覽系統（活動組織視角）
2. 用戶切換到組織身份
3. 系統顯示組織的活動資源
4. 用戶創建的新活動將歸屬於組織
5. 用戶可以隨時切換回個人身份
```

## 六、統一界面設計方案

### 6.1 統一導航結構

導航結構對所有用戶保持一致，根據視角和情境調整內容：

```
+--------------------------------------------------+
|  SponLink         [視角切換]      [身份切換]      |
|                                                  |
|  +------------+   +---------------------------+  |
|  | 儀表盤     |   |                           |  |
|  | 活動瀏覽   |   |  頁面內容                 |  |
|  | 我的活動   |   |  （根據當前視角和身份     |  |
|  | 我的贊助   |   |   自動調整顯示內容）      |  |
|  | 會議管理   |   |                           |  |
|  | 設置       |   |                           |  |
|  +------------+   +---------------------------+  |
|                                                  |
+--------------------------------------------------+
```

### 6.2 情境化功能展示

- **上下文感知**：界面元素根據當前視角、身份和資源所有權調整
- **統一但適應**：保持界面結構一致，僅調整內容和操作選項
- **權限指示**：清晰指示用戶可執行的操作，避免無效點擊

### 6.3 典型界面元素自適應

以活動卡片為例：

- **基本信息**：所有用戶都能看到活動標題、時間、描述等
- **贊助選項**：所有登入用戶都能看到贊助按鈕
- **管理選項**：只有活動擁有者才能看到編輯、刪除等管理按鈕
- **組織標記**：若活動屬於組織，顯示組織標記

## 七、典型用戶場景

### 7.1 從瀏覽到贊助的流程

```
1. 用戶瀏覽活動列表
2. 點擊感興趣的活動查看詳情
3. 點擊「贊助此活動」按鈕
4. 若未登入，提示登入
5. 選擇贊助方案並完成付款
6. 贊助記錄自動添加到「我的贊助」
7. 用戶可切換到「贊助管理視角」查看所有贊助
```

### 7.2 創建和管理活動流程

```
1. 用戶點擊「創建活動」按鈕
2. 填寫活動詳情並提交
3. 系統根據當前身份（個人/組織）設置活動所有者
4. 活動顯示在「我的活動」列表中
5. 用戶可管理自己創建的活動
6. 用戶可切換到「活動組織視角」專注於活動管理
```

### 7.3 組織協作流程

```
1. 組織管理員切換到組織身份
2. 創建活動並設置贊助方案
3. 邀請團隊成員協作
4. 團隊成員登入後切換到該組織身份
5. 根據組織內權限共同完善活動
6. 活動發布後，組織成員可共同管理贊助和會議
```

## 八、實施建議

### 8.1 技術實現重點

1. **統一資源模型**
   - 所有資源都有明確的所有者（用戶或組織）
   - 基於所有權實現權限控制

2. **情境化UI組件**
   - 組件根據當前視角和身份自適應
   - 使用React Context或狀態管理庫提供情境信息

3. **視角與身份管理**
   - 實現視角切換機制（活動組織/贊助管理）
   - 實現個人/組織身份切換

4. **組織權限系統**
   - 實現簡化的組織內角色（管理員/成員/查看者）
   - 基於角色控制組織資源的訪問權限

### 8.2 實施優先級

1. **統一資源模型改造**
   - 添加所有權字段到所有資源表
   - 實現基於所有權的權限檢查

2. **統一界面開發**
   - 合併現有分散界面
   - 實現情境化內容展示

3. **視角切換機制**
   - 開發視角選擇器
   - 實現視角相關的內容過濾

4. **組織身份支持**
   - 實現組織模型
   - 開發組織切換機制

## 九、總結與優勢

### 9.1 新方案核心優勢

1. **消除角色限制**
   - 用戶不再被限制在單一角色中
   - 自然支持同時是贊助商和組織者的情境

2. **基於所有權的權限**
   - 簡化權限模型，更符合直覺
   - 減少權限檢查的複雜度

3. **視角而非角色**
   - 視角切換只改變信息展示，不改變權限
   - 提供更專注的任務視圖，提高效率

4. **統一一致的界面**
   - 避免在不同角色間建立多個獨立界面
   - 減少學習成本，提高用戶體驗

### 9.2 商業價值

1. **提高用戶留存**
   - 無縫體驗減少用戶流失
   - 鼓勵用戶探索更多功能

2. **簡化開發維護**
   - 統一界面減少代碼重複
   - 簡化權限模型降低維護成本

3. **支持企業客戶**
   - 組織協作功能滿足企業需求
   - 為高級企業方案創造機會

4. **平台擴展性**
   - 基於資源的設計更容易添加新功能
   - 視角模型可輕鬆擴展到新的使用場景

通過這種以資源所有權和視角切換為核心的設計，SponLink平台能為用戶提供更自然、連貫的體驗，消除傳統角色模型的限制，同時支持從個人到企業的各種使用場景。 

## 十、當前實現狀態與差距分析

在實施身份系統整合方案的過程中，我們目前已完成了部分重要修改，但仍存在一些差距和問題需要進一步改進。

### 10.1 已完成的改進

1. **移除了頁面訪問中的角色限制**
   - 所有已登入用戶現在可以訪問所有頁面，包括購物車、贊助商和組織者頁面
   - 修改了路由組件，不再檢查特定角色，只檢查用戶是否已登入

2. **統一了功能入口**
   - 在導航欄中顯示所有功能選項，而非基於角色顯示不同選項
   - 所有登入用戶都能看到「My Events」、「Create Event」、「My Sponsorships」等所有選項

3. **建立了基於視角的頁面顯示機制**
   - 實現了視角切換功能，添加了 `VIEW_TYPE` 枚舉和相關 API
   - 提供了 ViewSwitcher 元件，允許在活動組織和贊助管理視角之間切換

### 10.2 當前存在的問題

1. **角色定義與新系統原則衝突**
   - `src/lib/types/users.ts` 中的 `USER_ROLES` 仍然定義了固定的 SPONSOR 和 ORGANIZER 角色
   - `User` 接口仍然將角色作為用戶的固有屬性，而非基於資源所有權的動態角色
   - 多處代碼仍然使用 `hasRole` 函數來檢查固定角色，而非使用基於所有權的權限檢查

2. **Dashboard 視角切換功能問題**
   - 視角切換後導航沒有正確更新（直接導航到特定頁面，而非重新加載當前頁面）
   - 視角切換沒有保持一致的上下文（各模塊獨立讀取視角，而非通過全局上下文）
   - 用戶介面沒有充分反映當前視角（缺少視覺反饋）

3. **缺乏組織支持**
   - 尚未實現組織模型和組織成員管理
   - 無法在個人和組織身份之間切換
   - 缺乏組織內的權限控制

4. **缺乏基於資源所有權的權限控制**
   - `authService.ts` 雖有 `canManageResource` 函數，但多數頁面仍未使用
   - 缺乏統一的資源模型，資源未關聯到明確的所有者
   - 編輯和刪除操作未檢查資源所有權

### 10.3 與方案差距

1. **數據模型差距**
   - 未實現方案中建議的簡化用戶與資源模型
   - 缺乏組織相關的數據結構
   - 資源未包含所有權字段（ownerId 和 ownerType）

2. **權限模型差距**
   - 仍基於固定角色進行權限控制，而非基於資源所有權
   - 缺乏組織內的角色權限系統

3. **身份模型差距**
   - 用戶仍被限制在單一角色中，無法同時擁有多種身份
   - 缺乏在同一會話中切換身份的功能

### 10.4 後續工作重點

1. **重構用戶與角色模型**
   - 修改 `USER_ROLES` 枚舉和 `User` 接口，移除固定角色限制
   - 將 hasRole 函數替換為基於視角和資源所有權的權限檢查

2. **完善視角切換機制**
   - 修復 Dashboard 視角切換問題
   - 實現視角切換時的上下文保持
   - 增強視角切換的視覺反饋

3. **實現組織模型**
   - 添加組織和組織成員數據結構
   - 實現組織創建、管理和成員邀請功能
   - 添加組織與個人身份切換功能

4. **實現基於所有權的權限控制**
   - 為所有資源添加所有權字段
   - 更新所有編輯和刪除操作，基於所有權檢查權限
   - 統一使用 `canManageResource` 函數進行權限檢查

通過解決這些問題並填補差距，我們將能夠實現完整的身份系統整合方案，提供更靈活、直觀且強大的用戶體驗。

## 十一、最新整合進展（2023-08-18）

自上次評估以來，我們已取得以下關鍵進展：

### 11.1 已解決的問題

1. **修復登出功能**
   - 修復了 Header 和 Navbar 組件中的登出功能
   - 確保登出時清除所有用戶狀態和身份信息
   - 添加事件通知機制，確保所有組件及時響應登出操作

2. **實現資源所有權模型**
   - 創建了 `BaseResource` 接口，定義了所有資源的共同屬性：
     - `ownerId`: 資源所有者ID
     - `ownerType`: 所有者類型 (USER/ORGANIZATION)
     - `resourceType`: 資源類型
   - 為 Event 和 SponsorshipPlan 添加了所有權屬性
   - 定義了 `OWNER_TYPE` 枚舉，區分個人和組織資源

3. **實現基於所有權的權限檢查**
   - 創建了 `resourcePermissionService.ts` 服務，包含：
     - `isResourceOwner`: 檢查用戶是否為資源所有者
     - `hasResourcePermission`: 基於所有權和角色檢查權限
     - `canCreateResource`: 檢查用戶是否可創建特定資源
     - `setResourceOwnership`: 為新資源設置所有權信息

4. **整合資源服務與所有權模型**
   - 更新了 eventService 以使用資源所有權模型
   - 創建事件時自動設置所有權信息
   - 編輯和刪除操作前先檢查權限
   - 添加了按所有者過濾資源的函數

### 11.2 當前技術挑戰

1. **後向兼容性**
   - 舊代碼仍依賴固定角色，需要逐步遷移
   - 必須維護向後兼容的 API，避免破壞現有功能

2. **組織模型整合**
   - 組織成員和角色管理仍需完善
   - 需要實現組織邀請和加入功能

3. **前端支持**
   - 需要更新前端組件支持基於所有權的界面顯示
   - 權限檢查應與 UI 元素顯示/隱藏綁定

### 11.3 下一步工作計劃

1. **擴展所有權模型至其他資源**
   - 為 Meeting, Sponsorship 等資源添加所有權支持
   - 更新相應服務，整合權限檢查

2. **實現組織管理功能**
   - 創建組織管理頁面
   - 添加成員管理和角色分配功能

3. **優化視角切換體驗**
   - 完善 Dashboard 視角切換功能
   - 添加視覺反饋，增強用戶體驗

4. **遷移遺留代碼**
   - 逐步將 USER_ROLES 轉換為基於資源的動態角色
   - 重構路由權限控制，使用所有權取代角色檢查 