# SponLink 認證系統設計與實施文檔

## 目錄
1. [概述](#概述)
2. [需求與挑戰](#需求與挑戰)
3. [認證系統方案評估](#認證系統方案評估)
4. [模擬資料與真實使用者映射問題](#模擬資料與真實使用者映射問題)
5. [最終實施方案](#最終實施方案)
6. [階段性計劃](#階段性計劃)
7. [技術細節](#技術細節)
8. [未來擴展考量](#未來擴展考量)

## 概述

SponLink 平台需要一個強大、靈活且可擴展的認證系統，以支持多種使用者角色和視角切換功能。本文檔記錄了我們在選擇和實施認證系統過程中的考量、決策和實施細節。

## 需求與挑戰

### 核心需求
- 支持多種社交登入（至少 Google 和 Apple）
- 適配基於資源所有權的身份權限模型
- 支持使用者身份視角切換（活動組織者/贊助商）
- 具備擴展性，能夠支持未來多產品集成
- 自動處理使用者資料與資料庫的同步

### 主要挑戰
- 現有系統已有模擬資料與假使用者 ID，需要與真實認證系統整合
- 需要在個人開發低成本和企業級安全性之間找到平衡
- 平台預計每月有百萬級活躍使用者，需要考慮擴展性和成本
- 需要在多個產品間提供一致的使用者體驗

## 認證系統方案評估

我們評估了幾種不同的認證系統解決方案：

### 1. Neon Auth + Stack Auth

**優勢：**
- 與 Neon 數據庫無縫集成，自動同步使用者資料
- 直接支持外鍵關係，簡化數據關聯
- 提供多種社交登入支持
- 支持平台的資源所有權模型
- 低維護成本，無需額外服務器
- 提供完整 API 用於管理使用者

**劣勢：**
- 對自定義認證流程的控制較少
- 主要整合 Stack Auth，對其他提供商支持有限
- 較新的服務，社區支持尚不成熟
- 大規模使用（百萬級用戶）可能成本較高
  - 免費方案：10,000 活躍使用者/月
  - Team 方案：$49/月，支持 50,000 活躍使用者
  - Business 方案：百萬使用者級別預計每月費用 $500-1000

### 2. NextAuth.js (Auth.js)

**優勢：**
- 開源，自託管部署無直接許可證費用
- 高度靈活性，可自定義適應任何規模和需求
- 完全控制認證流程和資料
- 支持所有主流認證提供商
- 成本效益高，適合大規模部署

**劣勢：**
- 需要自行處理與數據庫的同步機制
- 需要更多的開發和維護工作
- 安全性依賴於開發者的實施質量

### 3. Keycloak

**優勢：**
- 企業級中央認證系統
- 高度靈活性，支持幾乎所有認證場景
- 單點登入(SSO)能力強大
- 成熟穩定，有大量企業實踐和社區支持

**劣勢：**
- 初始設置成本高（需要 2-5 天專門工作）
- 需要專人維護和監控
- 學習曲線陡峭
- 運行成本較高，需要額外服務器資源

## 模擬資料與真實使用者映射問題

在開發初期，我們使用了模擬資料，包括預設的測試賬號和與之關聯的活動、贊助等資料。當引入真實認證系統後，出現了如何將真實使用者 ID 與模擬資料 ID 對應的問題。

### 問題分析

- **模擬資料依賴性**：現有功能和測試資料都依賴於硬編碼的使用者 ID
- **真實 ID 不可預測**：真實使用者（尤其使用社交登入）的 ID 無法預先知道
- **資源關聯**：測試賬號綁定了活動等其他假資料，需要保持這些關聯

### 解決方案評估

我們評估了兩種主要解決方案：

#### 方案 1：ID 映射層（開發階段使用）
- 創建真實使用者 ID 到模擬使用者 ID 的映射機制
- 登入後動態建立映射關係，基於使用者的電子郵件
- 在資源訪問時進行 ID 轉換

#### 方案 2：為新使用者創建示範資料（生產環境適用）
- 為每個新使用者自動生成一組示範資料
- 首次登入時檢測並創建相應資料
- 不依賴硬編碼的 ID 映射

## 最終實施方案

考慮到項目當前階段和需求，我們決定採用以下解決方案：

### 短期解決方案（1-2 個月）：NextAuth.js + ID 映射

- 選擇 **NextAuth.js (Auth.js)** 作為認證提供者
  - 靈活性高，適合當前開發階段
  - 成本效益好，適合百萬級使用者規模
  - 支持所有主要社交登入提供商
  
- 實施 **ID 映射層**
  - 開發了 `userMapping.ts` 系統，處理真實 ID 到模擬 ID 的映射
  - 在登入時基於電子郵件地址建立映射關係
  - 提供 `getResourceOwner` 功能處理資源訪問時的 ID 轉換

### 中長期解決方案（3-6 個月）：Keycloak

- 當開始開發第 2-3 個產品時，引入 **Keycloak**
- 提供所有產品統一的認證後端
- 實現單點登入，提升使用者體驗
- 降低未來每個新產品的認證開發成本

## 階段性計劃

我們採取漸進式的認證系統演進計劃：

### 第一階段：開發與測試（當前）
- 使用 NextAuth.js 實現基本認證功能
- 實現 ID 映射系統，保持與模擬資料的兼容性
- 確保認證系統與現有功能的無縫集成

### 第二階段：生產準備（1-2 個月）
- 針對生產環境優化認證流程
- 實現「為新使用者創建示範資料」的機制
- 安全性和性能優化

### 第三階段：多產品集成（3-6 個月）
- 評估並引入 Keycloak 作為中央認證系統
- 實現跨產品單點登入
- 構建統一的使用者管理後台

## 技術細節

### NextAuth.js 實施細節

我們完成了以下實施步驟：

1. **安裝與配置**
   - 安裝 NextAuth.js: `npm install next-auth@beta`
   - 配置環境變數：
     ```
     NEXTAUTH_URL=http://localhost:3000
     NEXTAUTH_SECRET=...
     GOOGLE_CLIENT_ID=...
     GOOGLE_CLIENT_SECRET=...
     APPLE_CLIENT_ID=...
     APPLE_CLIENT_SECRET=...
     ```

2. **API 路由設置**
   - 創建 `src/app/api/auth/[...nextauth]/route.ts`
   - 配置 Provider（Google, Apple, Credentials）
   - 實現 JWT 和 Session 回調，處理用戶 ID 映射

3. **全局 Provider 集成**
   - 建立 `SessionProvider` 包裝所有組件
   - 整合到現有的 `AuthProvider` 中

### 使用者 ID 映射系統

我們實現了一個完整的 ID 映射系統：

1. **核心映射功能** (`src/lib/userMapping.ts`)
   - `getUserIdMapping` / `setUserIdMapping`：管理映射存儲
   - `setupUserIdMappingByEmail`：基於電子郵件建立映射關係
   - `getResourceOwner`：解析資源所有者 ID

2. **登入時的映射處理**
   - 在 Auth.js 的 Session 回調中設置初始映射
   - 在 `AuthProvider` 中處理 NextAuth 與傳統認證系統的兼容

3. **資源訪問時的 ID 解析**
   - 提供 `getResourceOwnerId` 方法供組件使用
   - 自動處理 ID 轉換，確保資源訪問的一致性

## 未來擴展考量

在系統繼續發展的過程中，我們需要注意以下幾點：

1. **數據遷移計劃**
   - 從模擬資料到真實使用者生成的資料的平滑過渡
   - 考慮如何保留有價值的測試資料

2. **多產品認證統一**
   - 規劃 Keycloak 的部署和配置
   - 設計跨產品的統一權限模型

3. **擴展性與性能優化**
   - 針對百萬級用戶進行系統性能調優
   - 考慮認證服務的高可用性和容錯性

4. **安全性加強**
   - 實施多因素認證
   - 定期安全審核和更新

---

本文檔將隨著項目的發展持續更新，以記錄認證系統的演進和改進。 