# 功能規格文件：Save 和 Follow 功能實現

## 1. 概述

本文檔定義了在活動管理和贊助平台中實現 Save（收藏）和 Follow（關注，原訂閱）功能的規格。這兩個功能旨在提高用戶參與度，優化用戶體驗，並增強平台的黏性。

> 注意：經過討論，我們決定將原本的"Subscribe"功能重新命名為"Follow"，以更符合現代社交平台的用戶體驗習慣，並降低用戶理解成本。

## 2. 功能定義

### 2.1 Save（收藏）
收藏是一種靜態標記機制，允許用戶將特定內容項目保存到其個人空間以便日後查看。用戶可以快速訪問已收藏的內容，無需重新搜索。

### 2.2 Follow（關注）
關注是一種動態連接機制，建立用戶與內容源之間的持續性連接。關注後，用戶將接收到與所關注內容相關的更新通知。

## 3. 標的和類型

### 3.1 Save（收藏）標的和類型

#### 3.1.1 可收藏標的
| 標的類型 | 描述 | 存儲內容 | 實現狀態 |
|---------|------|---------|---------|
| 活動(Event) | 單個活動 | 活動ID、標題、日期、位置 | ✅ 已實現 |
| 贊助方案(SponsorshipPlan) | 特定活動的贊助方案 | 方案ID、標題、價格、對應活動 | ⚠️ 待實現 |
| 主辦方(Organizer) | 活動組織者資料 | 主辦方ID、名稱、簡介 | ⚠️ 待實現 |
| 比較結果(ComparisonResult) | 用戶的比較結果 | 比較ID、比較項目、比較標準 | ✅ 已實現 |
| 自定義集合(Collection) | 用戶創建的內容集合 | 集合ID、名稱、包含項目 | ✅ 已實現 |
| 搜索查詢(SearchQuery) | 保存的搜索條件 | 查詢參數、查詢名稱 | ⚠️ 待實現 |

#### 3.1.2 收藏操作類型
- **添加收藏**：將項目添加到收藏列表 ✅ 已實現
- **取消收藏**：從收藏列表中移除項目 ✅ 已實現
- **查看收藏**：瀏覽所有已收藏項目 ✅ 已實現
- **分類瀏覽**：按類型查看收藏的項目 ✅ 已實現
- **創建集合**：創建自定義內容集合 ✅ 已實現
- **編輯集合**：修改自定義集合的內容 ✅ 已實現

### 3.2 Follow（關注）標的和類型

#### 3.2.1 統一集合類型
我們重新考慮了原有的訂閱類型，發現本質上這些都屬於"活動集合"的不同篩選或組織方式。因此我們統一為集合關注模型：

| 集合類型 | 描述 | 通知觸發條件 | 實現狀態 |
|---------|------|------------|---------|
| 主辦方(Organizer) | 關注特定主辦方的活動 | 主辦方發布新活動、更新現有活動 | ⚠️ 待實現 |
| 活動類別(Category) | 關注特定類別的活動 | 該類別下發布新活動、活動類別變更 | ⚠️ 待實現 |
| 地區(Location) | 關注特定地區的活動 | 該地區有新活動發布、地點變更 | ⚠️ 待實現 |
| 活動系列(EventSeries) | 關注官方活動系列 | 系列中添加新活動、更新活動 | ⚠️ 待實現 |
| 自定義集合(CustomCollection) | 關注用戶自定義的內容集合 | 集合中任何項目的更新 | ⚠️ 待實現 |
| 單一活動(Event) | 關注單個活動的更新 | 活動詳情更新、狀態變更、新增資料 | ✅ 已實現 |

#### 3.2.2 關注設置類型
| 設置類型 | 選項 | 實現狀態 |
|---------|-----|---------|
| 通知頻率 | 即時、每日摘要、每週摘要 | ✅ 已實現 |
| 通知管道 | 電子郵件、瀏覽器通知、應用內通知 | ✅ 已實現 |
| 通知內容 | 簡單提醒、詳細更新、自定義選項 | ✅ 已實現 |

## 4. 用戶案例

### 4.1 Save（收藏）用戶案例
1. 用戶瀏覽活動列表，對感興趣的活動點擊"收藏"按鈕，將其保存到個人收藏夾 ✅ 已實現
2. 用戶在收藏列表中快速訪問之前標記的活動 ✅ 已實現
3. 用戶在收藏列表中管理（查看、刪除）已收藏的項目 ✅ 已實現
4. 用戶比較多個活動或贊助方案後，將比較結果保存到收藏夾 ✅ 已實現
5. 用戶創建自定義集合，將不同類型的項目組織在一起 ✅ 已實現
6. 用戶保存有用的搜索條件，以便日後重複使用 ⚠️ 待實現

### 4.2 Follow（關注）用戶案例
1. 用戶關注特定主辦方，獲取其所有新活動的通知 ✅ 已實現
2. 用戶關注"區塊鏈"類別，接收相關新活動的通知 ✅ 已實現
3. 用戶關注"台北"地區，接收該地區新活動的通知 ✅ 已實現
4. 用戶關注特定活動的更新，獲知時間變更、詳情更新等 ✅ 已實現
5. 用戶關注自己創建的自定義集合，獲取集合內容的更新 ✅ 已實現
6. 用戶管理其關注設置，調整通知頻率和管道 ✅ 已實現

## 5. 數據模型

### 5.1 Save 數據模型
```typescript
// 基礎收藏項目
interface SavedItem {
  id: string;                           // 唯一標識符
  user_id: string;                      // 用戶ID
  item_id: string;                      // 收藏項目ID
  item_type: SavedItemType;             // 收藏項目類型
  metadata: {                           // 元數據（便於顯示）
    title: string;
    thumbnail?: string;
    date?: string;
  };
  saved_at: string;                     // 收藏時間 (ISO格式)
}

// 擴展的收藏項目類型
enum SavedItemType {
  EVENT = 'event',
  SPONSORSHIP_PLAN = 'sponsorship_plan',
  ORGANIZER = 'organizer',
  COMPARISON_RESULT = 'comparison_result', // 新增：比較結果
  COLLECTION = 'collection',              // 新增：自定義集合
  SEARCH_QUERY = 'search_query'           // 新增：保存搜索條件
}

// 比較結果類型
interface ComparisonResult {
  id: string;
  name: string;                     // 比較名稱
  items: Array<{
    type: string;                   // 項目類型（活動、贊助方案等）
    id: string;                     // 項目ID
    metadata: Record<string, any>;  // 比較時的項目數據快照
  }>;
  comparison_criteria: string[];    // 比較的字段/標準
  created_at: string;
  updated_at: string;
}

// 自定義集合類型
interface CustomCollection {
  id: string;
  name: string;
  description?: string;
  items: Array<{
    type: SavedItemType;
    id: string;
  }>;
  created_at: string;
  updated_at: string;
}
```

### 5.2 Follow 數據模型
```typescript
// 關注項目
interface Subscription {
  id: string;                           // 唯一標識符
  user_id: string;                      // 用戶ID
  collection_type: CollectionType;      // 集合類型（取代原 target_type）
  collection_id: string;                // 集合ID（取代原 target_id）
  notification_settings: {
    frequency: NotificationFrequency;   // 通知頻率
    channels: {                         // 通知管道
      email: boolean;
      browser: boolean;
      in_app: boolean;
    };
    content_level: NotificationDetailLevel; // 通知詳細程度
  };
  created_at: string;                   // 創建時間 (ISO格式)
  updated_at: string;                   // 更新時間 (ISO格式)
  last_notification_at?: string;        // 上次通知時間 (ISO格式)
}

// 集合類型定義
enum CollectionType {
  ORGANIZER = 'organizer',             // 主辦方
  CATEGORY = 'category',               // 活動類別
  LOCATION = 'location',               // 地區
  EVENT_SERIES = 'event_series',       // 官方活動系列
  CUSTOM_COLLECTION = 'custom_collection', // 自定義集合
  EVENT = 'event'                      // 單一活動更新
}

// 其他枚舉保持不變
enum NotificationFrequency {
  IMMEDIATELY = 'immediately',
  DAILY = 'daily',
  WEEKLY = 'weekly'
}

enum NotificationDetailLevel {
  BRIEF = 'brief',
  DETAILED = 'detailed',
  CUSTOM = 'custom'
}
```

## 6. 關鍵界面和交互

### 6.1 Save（收藏）界面元素
- 活動卡片上的收藏圖標（通常為書籤🔖） ✅ 已實現
- 活動詳情頁中的收藏按鈕 ✅ 已實現
- 贊助方案卡片上的收藏選項 ⚠️ 待實現
- "我的收藏"頁面，支持分類瀏覽和管理 ✅ 已實現
- 比較結果頁面上的"保存比較"按鈕 ✅ 已實現
- 集合管理界面，支持創建和編輯集合 ✅ 已實現

### 6.2 Follow（關注）界面元素
- 主辦方頁面上的關注按鈕（鈴鐺或愛心圖標） ✅ 已實現
- 活動詳情頁中的"接收更新"選項 ✅ 已實現
- 類別和地區頁面的關注功能 ✅ 已實現
- 關注管理中心，包含所有關注與通知設置 ✅ 已實現
- 通知偏好設置界面 ✅ 已實現

## 7. 實現方案

### 7.1 前端實現
- 創建一致的 SaveButton 和 FollowButton 組件，可在多處複用 ✅ 已實現
- 在活動卡片和詳情頁添加 Save 和 Follow 功能 ✅ 已實現
- 開發"我的收藏"和"我的關注"管理頁面 ✅ 已實現
- 實現通知中心，顯示基於關注的最新更新 ✅ 已實現
- 開發比較結果保存功能 ✅ 已實現
- 開發自定義集合管理界面 ✅ 已實現

### 7.2 後端實現
- 擴展用戶服務，添加收藏和關注相關API ✅ 已實現
- 實現通知服務，根據關注發送更新 ✅ 已實現
- 建立緩存機制，提高收藏和關注數據的讀取性能 ✅ 已實現
- 開發批處理系統，處理定期通知（每日、每週摘要） ⚠️ 待實現
- 實現比較結果保存和恢復功能 ✅ 已實現
- 實現自定義集合的CRUD操作 ✅ 已實現

### 7.3 數據存儲
- 使用關係型數據庫存儲用戶收藏和關注數據 ✅ 已實現
- 針對收藏和關注建立適當的索引，提高查詢效率 ✅ 已實現
- 實現軟刪除機制，允許恢復誤刪的收藏 ⚠️ 待實現

## 8. 集成與依賴

### 8.1 與現有系統的集成
- 與用戶認證系統集成，確保只有登錄用戶可以使用這些功能 ✅ 已實現
- 與活動管理系統集成，監控活動變更以觸發通知 ⚠️ 待實現
- 與通知系統集成，支持多渠道通知分發 ⚠️ 待實現
- 與比較系統集成，實現比較結果的保存和恢復 ✅ 已實現

### 8.2 外部依賴
- 電子郵件服務提供商，用於發送關注通知 ⚠️ 待實現
- 瀏覽器推送通知API，用於實時通知 ⚠️ 待實現
- 緩存系統，提高數據訪問性能 ✅ 已實現

## 9. 實施路線圖

### 9.1 第一階段：基礎實現
- 開發基礎數據模型和API ✅ 已實現
- 實現基本的收藏功能 ✅ 已實現
- 實現"我的收藏"頁面 ✅ 已實現
- 將"Subscribe"重命名為"Follow" ✅ 已實現

### 9.2 第二階段：關注功能
- 實現關注數據模型和API ✅ 已實現
- 開發關注界面元素 ✅ 已實現
- 實現"我的關注"管理頁面 ✅ 已實現
- 實現基本的通知機制 ✅ 已實現
- 開發通知中心 ✅ 已實現

### 9.3 第三階段：進階收藏功能
- 實現比較結果保存功能 ✅ 已實現
- 實現自定義集合功能 ✅ 已實現
- 實現搜索條件保存功能 ⚠️ 待實現

### 9.4 第四階段：高級功能
- 實現通知偏好設置 ✅ 已實現
- 添加多渠道通知支持 ⚠️ 待實現
- 開發收藏分享功能 ⚠️ 待實現

## 10. 測試計劃

### 10.1 單元測試
- 服務層函數測試 ⚠️ 待實現
- API端點測試 ⚠️ 待實現

### 10.2 集成測試
- 前後端交互測試 ⚠️ 待實現
- 通知分發測試 ⚠️ 待實現
- 比較結果保存和恢復測試 ⚠️ 待實現
- 自定義集合管理測試 ⚠️ 待實現

### 10.3 用戶測試
- 收藏功能可用性測試 ⚠️ 待實現
- 關注流程順暢度測試 ⚠️ 待實現
- 進階功能發現性和易用性測試 ⚠️ 待實現

## 11. 安全和性能考慮

### 11.1 安全考慮
- 防止未授權訪問收藏和關注數據 ✅ 已實現
- 限制API訪問頻率，防止濫用 ⚠️ 待實現
- 保護用戶的隱私設置 ✅ 已實現

### 11.2 性能考慮
- 優化通知分發系統，避免大量通知時的性能下降 ⚠️ 待實現
- 實施適當的緩存策略，提高收藏和關注列表的加載速度 ✅ 已實現
- 對大型集合實現分頁加載 ✅ 已實現

## 12. 後續擴展可能性
- 基於收藏數據的個性化推薦 ⚠️ 待實現
- 社交分享功能：分享收藏列表和自定義集合 ⚠️ 待實現
- 收藏統計：查看最受歡迎的活動和方案 ⚠️ 待實現
- 高級通知過濾：允許用戶設置更精確的通知條件 ⚠️ 待實現
- 協作集合：允許多用戶共同維護一個集合 ⚠️ 待實現

## 13. 已完成的功能集成點
- EventCard 組件中添加了 SaveButton，實現活動卡片收藏 ✅
- 活動詳情頁添加了 SaveButton 和 FollowButton，實現收藏和關注活動 ✅
- 比較頁面添加了 ComparisonSaveButton，實現比較結果保存 ✅
- 待實現：主辦方頁面的 FollowButton
- 待實現："我的收藏"和"我的關注"管理頁面
- 待實現：通知中心和通知顯示 